---
title: "Final Assignment"
output: html_document
date: "2024-03-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction
For this project we are going to be using the STAR dataset which is an experiment conducted in the 1980s that tried to evaluate the effectiveness of class sizes on test scores. The focus will primarily be on the effects of class size on first grade math scores. Specifically we want to see if there is any difference in first grade math scores across different class sizes and if so what class size is the most effect in increasing test scores.

# Background and Motivation
In 1985, Tennessee passed legislation giving funding to test a policy study to determine the effects of class size on student achievement in primary grades. The main questions asked during this study are:

1. What are the effects of reduced class size on achievement (criterion tests) and development of students in public elementary school grades k-3.
2. Is there a cumulative effect of being in a small class size over an extended time (4 years) as compared with students in a small class size over a single year?
3. Does training program designed to help teachers maximize small classes or training which helps teachers effectively use aides improve student performance over teachers with no special training?

# Experimental Design and Criticisms
For the experiment, students who enrolled in schools participating in the experiment (of which there were 79 schools participating) were randomly assigned to one of three classrooms:

1. Small (17 students maximum)
2. Regular(22-25)
3. Regular + Aide (22-25)

From there test scores for students would be tracked and analysed to see if class type had an effect. In total 11,601 students were observed throughout the experiment, however of this total only 26% fully participated in the STAR project for all four consecutive years (k-3).

This is a point of criticism in the design of the experiment as only having about 1/4 of the total participants managing to participate in the original design experiment would most likely effect the data observed. This however, is an expected outcome as students were not forced to participate in the experiment and switching classes or schools due to external circumstances is simply a fact of life. Another issue from a design standpoint is that kindergarten in Tennessee is not required (at least during the time of the experiment) which means a larger influx of students began participating at 1st grade. This is further emphasized by the fact (as mentioned before) only 26% fully participated in the original experiment design. Because of this, even though it may not have entirely answered the effects of small class sizes on early development, it may have been better to start the experiment in 1st grade rather than kindergarten. 

Additionally, classroom shift is an issue for this study. Classroom shift is when a student moves from one classroom to another (small -> regular etc). The dataset tries to alleviate this by including tags that extract information on these shifts called CMPSTYPE and CMPSDURA. CMPSTYPE is a flag which indicates the type of classroom they were in and CMPSDURA measure how long they were in said classroom. The issue with CMPSTYPE is that should a student move in and out of a small classroom at least once, for example s->r->s or s->s->r->s then they are tagged as missing. In addition they are also tagged as missing should they join a small classroom past 1st grade. This removes a lot of information that could be gleaned from these shifts but may also help simplify analysis depending on the goal of the analysis. Because of these shifts, another issue arises where classes tagged as regular may reduce to ranges not specified (18-21) or may even reach  levels of small class sizes. Similarly, small class sizes could reach ranges that are not specified (11-12). However, even with all these issues, the experiment design should not be discounted. It still helps glean information on the importance of class size in children development and should not be ignored due to these issues that arise due to shifts that occur naturally in life. Instead these issues should be taken into account when analysing the data so as to not make incorrect conclusions.

# Caveats
In the initial analysis report, I found some issues with the model used. Firstly, one main assumption used in the model is that there were equal number of samples for eat treatment level. However, the number of samples in each treatment (schoolid and classroomtype) were imbalanced which would lead to problems in the analysis. In addition, another assumption was that $\{e_{ijk}\} \overset{\mathrm{iid}}{\sim} N(0, \sigma^2)$ which when looking at the normal QQ plot was most likely not true under the original model. 

Additionally, the original model only looked at school id (due to it being a stratified design) and class size as factors. However, there may be other factors that should be taken into account, for example socioeconomic factors or ethnicity may play a role in addition to other factors such as teacher education etc. This should be further inspected.

Another caveat was that the stratified experiment design may have been violated for students continued through the project from kindergarten to first grade. This is because, the experimenters did not see much effect between teacher and teacher + aide in kindergarten so they took half of the students who were moving to first grade and moved them between the two groups. The fact that the switch occurred may have effected the design for the students moving to first grade and beyond.

Finally, there was a lot of missing data throughout the dataset and should be further analysed to see if patterns emerged in key factors that may be used in the final model.

# EDA

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(haven)
library(foreign)
```

```{r, warning=FALSE, echo=FALSE}
df = read.spss("Data/STAR_students.sav", to.data.frame=TRUE)
df1 = read.spss("Data/STAR_K-3_Schools.sav", to.data.frame=TRUE)
```

```{r, echo=FALSE, include=FALSE}
head(df)
```

```{r, include=FALSE}
missing <- df %>% 
  group_by(g1schid) %>%
  summarize(count = n_distinct(g1classtype)) %>%
  filter(count <=2)
```


### Missing Mechanism (Missing grade 1 classtype)

```{r}
missing %>%
  inner_join(df, by = "g1schid") %>%
  select(g1schid, g1classtype) %>%
  distinct() %>%
  arrange(g1schid, g1classtype)
```
Out of all the schools participating in this experiment, there were 4 schools that were missing one of the treatment groups. In all 4 cases each school was missing the regular + aide class.

```{r}
id_missing <- missing %>%
  inner_join(df, by = "g1schid") %>%
  select(g1schid) %>%
  distinct()
```




```{r}
missing %>%
  inner_join(df1, by=c('g1schid' = 'schid')) %>%
  select(c('g1schid', 'SCHLURBN'))
```

Of these schools, 3 of the four were inner city schools and only 1 was a suburban school. None of the schools missing regular + aide treatment came from urban or rural schools.



```{r, echo=FALSE, warning=FALSE}
suburban_free <- df1 %>%
  filter(SCHLURBN == "SUBURBAN") %>%
  select(schid, G1FRLNCH)

suburban_free$highlight <- ifelse(suburban_free$schid %in% id_missing$g1schid, "missing_aide", "regular")


ggplot(suburban_free, aes(x=as.factor(schid), y=G1FRLNCH, fill=highlight, na.rm = TRUE)) +
  geom_bar(stat = 'identity', color='black') +
  scale_fill_manual(values = c("regular" = "skyblue", "missing_aide" = "orange")) +  # Adjust colors as needed
  labs(x = "School ID", y = "Proportion of Students with Free Lunch", title = "Proportion of Students with Free Lunch by Suburban Schools") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Looking at suburban schools, the one missing the aide class is not very different in terms of students with free lunches compared to other suburban schools. This means at least the proportion of students having free lunch (and by extension socioeconomic status) did not affect why the school was missing one of the treatment group.

```{r, echo=FALSE, warning=FALSE}
#graph free lunch for inner city school and demographics
innercity <-  df1 %>% filter(SCHLURBN=='INNER CITY') %>%
  select(schid, G1FRLNCH, G1ASIAN, G1BLACK, G1HSPANC, G1WHITE, G1OTHRAC)

innercity$highlight <- ifelse(innercity$schid %in% id_missing$g1schid, "highlight", "regular")

ggplot(innercity, aes(x=as.factor(schid), y=G1FRLNCH, fill=highlight, na.rm = TRUE)) +
  geom_bar(stat = 'identity', color='black') +
  scale_fill_manual(values = c("regular" = "skyblue", "highlight" = "orange")) +  # Adjust colors as needed
  labs(x = "School ID", y = "Proportion of Students with Free Lunch", title = "Proportion of Students with Free Lunch by School") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Similarly for Inner city schools, the proportion of students with free lunch is not very different when comparing those that were missing a treatment group and those that had all 3 treatment groups.

```{r, warning=FALSE}
strings_to_search <- c("G1NATVAM", "G1ASIAN", "G1BLACK", "G1HSPANC", "G1WHITE", "G1OTHR")

# Group by school ID and calculate the total student population

pop <- df1 %>%
  select(c('schid', contains(strings_to_search), 'SCHLURBN')) %>%
  summarize(
    schid,
    SCHLURBN,
    total_population = rowSums(select(., contains(strings_to_search)), na.rm=TRUE)
  )

pop$highlight <- ifelse(pop$schid %in% id_missing$g1schid, "missing_aide", "regular")

ggplot(pop, aes(x=as.factor(schid), y=total_population, fill=highlight, color=SCHLURBN, na.rm = TRUE)) +
  geom_bar(stat = 'identity', color='black') +
  scale_fill_manual(values = c("regular" = "skyblue", "highlight" = "orange")) +  # Adjust colors as needed
  labs(x = "School ID", y = "Population of G1 Students", title = "Student Population") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Another potential reason that the four schools were missing a grade 1 teacher aide class in the experiment was that perhaps they did not have enough students to fulfill the classroom requirements and therefore chose to forgo the teacher + aide class. However, upon further inspection, it is evident that at least for grade 1 that there were enough students to participate in all 3 class types in addition, the schools that were missing the aide treatment had similar g1 population to other schools.

Currently there are no discernible patterns on why these 4 schools were missing teacher aide class so it with the current knowledge it is believable to say that it is missing at random. In addition, according to the background, after the first set of students transitioned from kindergarten to first grade, they saw no discernible difference between regular classroom and regular + aide classroom. Therefore, it should not pose a problem to ignore the fact that these schools are missing a treatment.



### Missing Mechanism (Missing Grade 1 math score)

```{r, include=FALSE}
filtered_df <- df %>%
  select(-contains("g3"), -contains("g4"), -contains("g5"), -contains("g6"), -contains("g7"), -contains("g8"), -starts_with("hs"), -contains("flagidn8")) 

filtered_df1 <- filtered_df %>%
  filter(!is.na(g1tmathss))
  
filtered_df1
```

Looking through the data which has a grade 1 math score, all of them were participating in the grade 1 star project. This means the students missing grade 1 math score should be looked at to see if there are any patterns and information that could be extracted.

```{r, include=FALSE}
na_filtered <- filtered_df %>%
  filter(is.na(g1tmathss))

count_data <- table(na_filtered$FLAGSG1)

# Create a bar plot of count of YES and NO values
ggplot(data.frame(Response = names(count_data), Count = as.numeric(count_data)), aes(x = Response, y = Count)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(aes(label = Count), vjust = -0.5, color = "black", size = 3) +
  labs(x = "Response", y = "Count", title = "Number of Students Participating in G1 Star and Missing Math Score") +
  theme_minimal()
```



The student's missing a grade 1 math score can be split into two groups, those who were participating in project STAR and those were not during first grade. It is very difficult to see why these students were missing a grade 1 math score even though they were participating in the STAR project during grade 1. Looking at gender, it seems as though males were more likely to miss a grade 1 score but females also had a non significant amount of students missing as well meaning it is difficult to use gender as an underlying pattern. Similarly, although students living in rural areas are more likely to be missing a grade 1 score, other areas were missing a decent amount of grade 1 tests information proportionally speaking. This means, that similar to gender, where a student was living (and potentially by extension their socioeconomic status) is not an underlying factor to why the variable is missing. Another potential pattern was seeing if a student that did not have a reading score would also be missing their math score. Approximately half of the students who had a reading score were missing their math score meaning this was also a not good indicator for why students were missing a math score. Because of this it is difficult to determine a pattern of missingness and therefore I will be ignoring these students whow were missing a math score even though they were participating in the g1 STAR project.  This may have been due to different errors such as the students were absent or maybe there was an error while inputting the data (some students were missing gender or race for example). Either way because of the difficulty in determining a pattern given the current data, I will be removing the students who were missing a grade 1 math score who were also participating in the grade 1 STAR project. (Tables can be seen in the appendix below)

Because there is not obvious missing mechanism, I will be utilizing a linear regression model to impute the missing data for these students missing grade 1 math scores while participating in project STAR. I will be utilizing their kindergarten and second grade reading and math scores to complete this task. In addition, should these missing students be missing their kindergarten and second grade scores, I will remove them from the dataset.

### Imputation Method

```{r}

na_filtered_yes <- na_filtered %>%
  filter(FLAGSG1 == "YES")

add_dataset <- na_filtered_yes %>%
  filter(FLAGSGK == "YES", FLAGSG2 == "YES")

add_dataset <- add_dataset %>%
  filter(!is.na(gktreadss), !is.na(gktmathss), !is.na(g2tmathss), !is.na(g2treadss))


add_dataset <- add_dataset %>%
  filter(!is.na(g1freelunch)) %>%
  filter(!is.na(g2freelunch))

add_dataset <- add_dataset %>%
  mutate(g1freelunch = ifelse(is.na(g1freelunch), as.character(g2freelunch), as.character(g1freelunch)))

combined <- bind_rows(filtered_df1, add_dataset)

```



```{r}

both <- combined %>%
  filter(!is.na(gktreadss),!is.na(gktmathss), !is.na(g1tmathss), !is.na(g2tmathss), !is.na(g2treadss))

pred_model <- lm(g1tmathss ~ gktreadss + gktmathss + g2tmathss, g2treadss, data=both)
pred_model

```

This is a simple model used for imputation, it looks at a child's kindergarten and second grade math and reading scores to predict their first grade math and reading scores. Kindergarten and second grade scores will be used for imputation because it is believed that these scores will be good indicators for how well a student does for testing. Kindergarten is a good indicator for first grade as a good score in kindergarten most likely results in a good score for first grade. Similarly because first grade scores is most likely a good indicator on second grade scores, we can use the second grade scores as a indicator for first grade scores as well. Because of this, by utilizing both kindergarten and second grade a better idea of how well a student does in first grade can be formed which allows for a more accurate imputation. The model the coefficients for the linear regression model is shown above.


```{r, include=FALSE}

predictor_columns <- names(pred_model$model)[-1]


df_subset <- add_dataset[complete.cases(add_dataset[, predictor_columns]), predictor_columns]

predicted_values <- predict(pred_model, newdata = df_subset)





add_dataset$g1tmathss[is.na(add_dataset$g1tmathss)] <- predicted_values[is.na(add_dataset$g1tmathss)]

add_dataset$g1tmathss <- as.integer(add_dataset$g1tmathss)

```

### Analysis on Student switching

```{r, include=FALSE}
combine <- unique(rbind(filtered_df1, add_dataset))

combine_id <- combine %>%
  inner_join(df1, by=c("g1schid" = "schid"))

combine_id <- combine_id %>%
  mutate(g1freelunch = ifelse(is.na(g1freelunch), as.character(gkfreelunch), as.character(g1freelunch)))
combine_id <- combine_id %>%
  filter(!is.na(g1freelunch))


combine_id$g1freelunch <- gsub("NON-FREE", "NON_FREE", combine_id$g1freelunch)

combine_id$g1classtype <- gsub("\\+", "", combine_id$g1classtype)
combine_id$gkclasstype <- gsub("\\+", "", combine_id$gkclasstype)

combine_id <- combine_id %>%
  mutate(switch = ifelse(gkclasstype == g1classtype, "NO", "YES"))

combine_id <- combine_id %>%
  mutate(switch = ifelse(is.na(gkclasstype), "NOT APPLICABLE", switch))

combine_id %>%
  select(gkclasstype, g1classtype, switch)

```

```{r}
combine_id %>%
  filter(!is.na(gkclasstype), !is.na(g1classtype)) %>%
  group_by(switch) %>%
  summarize(prop = n()) %>%
  mutate(prop = prop / sum(prop))

```

Looking at the table, of the students that participating in both kindergarten and first grade about 39% of them switched. Unfortunately due to time constraints I was not able to take into account the mechanism of switch. It includes all types of switch (small -> regular, regular -> small, etc). Because of that, it is difficult to extract which ones switched due to experimenter interference and which switched due to life happenstance.


### Covariate Analysis

```{r, warning=FALSE, include=FALSE}
library(gplots, warn.conflicts = FALSE)
```


```{r, echo=FALSE}
ggplot(combine, aes(x=g1tmathss))+
  geom_density(fill='skyblue', color='black')+
  labs(x="math scores", y='density', title="kernel density of student's math score")
```

Looking at the kernel density plot, the math scores potentially follows an approximate normal distribution. Because of this, I will model this data at the student level rather than the teacher level as previously done in the initial analysis report. Besides the possibility of it being normally distributed, I will also utilize the scores at a student level because it will allow better usage of other covariates such as switch status.

```{r, warning=FALSE}

avg_math_scores_classtype <- combine_id %>%
  group_by(g1classtype) %>%
  summarise(avg_math_score = mean(g1tmathss, na.rm = TRUE),
            ci_lower = mean(g1tmathss, na.rm = TRUE) - qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)),
            ci_upper = mean(g1tmathss, na.rm = TRUE) + qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)))


ggplot(avg_math_scores_classtype, aes(x=g1classtype, y=avg_math_score)) +
  geom_point() +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width = 0.2)+
  labs(x = "class type", y = "Average Math Score", title = "Average Math Score by Class Type") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```



```{r, warning=FALSE, echo=FALSE}


avg_math_scores_freelunch <- combine_id %>%
  group_by(g1freelunch) %>%
  summarise(avg_math_score = mean(g1tmathss, na.rm = TRUE),
            ci_lower = mean(g1tmathss, na.rm = TRUE) - qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)),
            ci_upper = mean(g1tmathss, na.rm = TRUE) + qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)))


ggplot(avg_math_scores_freelunch, aes(x=g1freelunch, y=avg_math_score)) +
  geom_point() +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width = 0.2)+
  labs(x = "Free Lunch Status", y = "Average Math Score", title = "Average Math Score by Free Lunch Status") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r}
avg_math_scores_switch <- combine_id %>%
  group_by(switch) %>%
  summarise(avg_math_score = mean(g1tmathss, na.rm = TRUE),
            ci_lower = mean(g1tmathss, na.rm = TRUE) - qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)),
            ci_upper = mean(g1tmathss, na.rm = TRUE) + qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)))


ggplot(avg_math_scores_switch, aes(x=switch, y=avg_math_score)) +
  geom_point() +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width = 0.2)+
  labs(x = "Free Lunch Status", y = "Average Math Score", title = "Average Math Score by Free Lunch Status") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r, echo=FALSE}
interaction.plot(combine_id$switch, combine_id$g1freelunch, combine_id$g1tmathss
                ,cex.lab=1.5,ylab="Average Math Score",xlab='SwitchStatus', trace.label = "Free Lunch Status")

```



Main effect plot for class size vs average math score indicates that class size has an effect on average math score. Similarly the main effect plot for free lunch status vs average math score also shows that lunch status had an effect on math scores. One important note in the graph above is the main effect of switch status on math scores. There seems to be a large effect switch status has, however, upon a deeper look this effect is attributed to those who count as non applicable. These students were those who did not switch (which includes those in those who joined in first grade). Because of this there is most likely a lot of information that came from other covariates. Unfortunately due to time constraints, I was not able to find a way to create better flags to better capture the nuances of the information. However, since there is an effect I will keep switch status in the model. 

# Model Creation

Given my initial analysis of the data the current model proposed is $Y_{ijkl} = \mu_{....} + \alpha_i + \beta_j + \gamma_k + \delta_l + \epsilon_{ijkl}$ where:

\begin{align}

\mu_{....} &= \text{ overall average math score for a student} \\
\alpha_i &= \text{ the effect of the ith class size on a student's math score} \\
\text{i = 1,2,3} \\
\beta_j &= \text{ the effect of free lunch status on a student's math score} \\
\text{j = 1,2} \\
\gamma_k &= \text{ the effect of the kth switch status on student's math score} \\
\text{k = 1,2,3} \\
\delta_l &= \text{ the effect of the lth school id on a student's math score} \\
\text{l = 1,...,75} \\

\end{align}

Since this data does not follow a normal distribution, we will the chi squared version of the model which does not assume normality

The main effect plots shown above provides evidence for why the first three covariates are chosen. School ID is chosen because it is general convention to include due to it being a stratified experiment. In addition, Interaction terms are ignored as the interaction plots do not show much effect between each other.



```{r}
combine_id$g1schid <- as.factor(combine_id$g1schid)
#Given that interaction seems to be significant it may be prudent to include it
t1=aov(g1tmathss~g1freelunch + g1classtype + switch + g1schid, data=combine_id)
anova(t1, test="Chisq")

```

### School ID Patterns

```{r, include=FALSE}
avg_math_scores <- combine_id %>%
  group_by(g1schid) %>%
  summarise(avg_math_score = mean(g1tmathss, na.rm = TRUE),
            ci_lower = mean(g1tmathss, na.rm = TRUE) - qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)),
            ci_upper = mean(g1tmathss, na.rm = TRUE) + qt(0.975, length(g1tmathss) - 1) * sd(g1tmathss, na.rm = TRUE) / sqrt(length(g1tmathss)),
            urbn = unique(SCHLURBN),
            frlnch = unique(G1FRLNCH))

urban <- avg_math_scores %>%
  filter(urbn == "URBAN") %>%
  arrange(desc(frlnch))

inner_city <- avg_math_scores %>%
  filter(urbn == "INNER CITY") %>%
  arrange(desc(frlnch))

sub <- avg_math_scores %>%
  filter(urbn == "SUBURBAN") %>%
  arrange(desc(frlnch))

rural <- avg_math_scores %>%
  filter(urbn == "RURAL") %>%
  arrange(desc(frlnch))

full_graph_data <- urban %>%
  bind_rows(sub, rural, inner_city)
```



```{r, warning=FALSE, echo=FALSE}
id_coef <- t1$coefficients[7:length(t1$coefficients)]

coef_df <- data.frame(Coefficients = unlist(id_coef))

coef_df <- rownames_to_column(coef_df, var = "index_column")

coef_df <- coef_df %>%
  rename(
    schid = index_column
  )

coef_df$schid <- sub("^g1schid", "", coef_df$schid)

full_graph_data_coef <- full_graph_data %>%
  inner_join(coef_df, by=c("g1schid" = "schid"))

full_graph_data_coef$g1schid <- factor(full_graph_data_coef$g1schid, levels = unique(full_graph_data_coef$g1schid))


ggplot(full_graph_data_coef, aes(x=g1schid, y=Coefficients, color = urbn)) +
  geom_point() +
  labs(x = "School ID", y = "Average Math Score", title = "Coefficients") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r, warning=FALSE, echo=FALSE}

full_graph_data$g1schid <- factor(full_graph_data$g1schid, levels = unique(full_graph_data$g1schid))


ggplot(full_graph_data, aes(x=g1schid, y=avg_math_score, color = urbn)) +
  geom_point() +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width = 0.2)+
  labs(x = "School ID", y = "Average Math Score", title = "Average Math Score by School ID") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Interestingly graphing the coefficients that school ID has from the model using a similar mechanism as how I graphed the average math school by school ID shows similar patterns. Unfortunately due to time constraints I could not determine what the underlying mechanism for why the pattern is similar between the two. I believe there may be a hidden covariate or an interaction that I have not discovered which would explain this pattern. This is further supplemented why I attempted to model which included an interaction between free lunch status and school ID. Again, a similar pattern emerged in the coefficients which further supplements the idea of a hidden mechanism that requires further analysis to find.

### Model Observations


The model proposed includes a student's grade 1 free lunch status, switch status, class type and school id. The model assumes no interaction which is similar to the model proposed in the initial analysis. The main differences is the inclusion of free lunch status and switch status, analyzing at the student level, and a deeper analysis on how the data was cleaned and which subjects were used for the model. The conclusions are similar to the initial analysis which concluded that both class type and schoolid had an effect on grade 1 math scores. The model in this case concludes that along with class type and schoolid, a student's free lunch status and switch status are  important treatment factors as well. 

# Sensitivity Analysis


```{r}

plot(t1, which=1)
```

The main assumptions that are being checked for the model is seeing if the variance of the residuals is fairly constant. Looking at the residual vs fitted plot, the overall spread of the residuals does not fan out as the x-axis increases which indicates that the residuals most likely has a constant variance throughout. Since we are using a chi-squared model, the normal assumption is not necessary to look at. However, it is important to see if a non parametric test leads to the same conclusion which indicates that the model gives information on the data rather than the model chosen changing the conclusion


```{r}
combine_id$rank <- rank(combine_id$g1tmathss)

summary(aov(rank~g1freelunch + g1classtype + switch + g1schid, data=combine_id))
```

Above is a rank-test anova model. It provides similar conclusions that the original model makes that class type, switching status as well as free lunch are both important factors in determining grade 1 test scores. Because of this, the conclusion is due to the model rather than the underlying methods chosen. Therefore, the model proposed grants information about the underlying mechanism of the data. 

Another problem that should be checked is the fact that the treatment groups do not have equal sample size. Below is a violin plot which shows the general distribution of number of students per treatment group. Looking at it, most groups fall between around 5-30 while only a few groups going past 40. Due to this unequal sample size, the type I test utilized which does a sequential algorithm may result in a different conclusion if the order of treatment groups is changed. It is important to check if this is the case and whether or not the conclusion changes due to this.

```{r, warning=FALSE}

options(dplyr.summarise.inform = FALSE)

df_num_students <- combine_id %>%
  group_by(g1schid, g1freelunch, g1classtype, switch) %>%
  summarize(num_students = n())

ggplot(data=df_num_students, aes(x="", y=num_students))+
  geom_violin(fill='skyblue') +
  geom_jitter(height=0.05, width=0.1) +
  geom_point(aes(y=mean(num_students)), color='red', size=4)
```

Looking at the three tables below, the order of the treatment variables were changed to see if there were any changes to the conclusion. If the conclusion changes, then the model proposed is sensitive to the uneven sample size in treatment groups which would mean the model proposed may lead to incorrect conclusions. In this case, the conclusion for each of these does not change indicating that the model is most likely valid.

```{r, echo=FALSE}
summary(aov(g1tmathss~g1classtype + g1schid + g1freelunch + switch, data=combine_id))
summary(aov(g1tmathss~g1schid + switch + g1classtype + g1freelunch, data=combine_id))
summary(aov(g1tmathss~g1schid + g1freelunch + switch +  g1classtype, data=combine_id))
```


Another analysis is to see if another model which includes some kind of interaction may be better to use. To test this we can use a full vs reduced model check which has the following hypothesis:

$H_o: Y_{ijkl} = \mu_{....} + \alpha_i + \beta_j + \gamma_k + \delta_l + \epsilon_{ijkl} \\$

$H_a: Y_{ijkl} = \mu_{....} + \alpha_i + \beta_j + \gamma_k + \delta_l + (\beta\gamma)_{.jk.} + \epsilon_{ijkl}$

Where the covariates are the same as proposed previously and $(\beta\gamma)_{jk}$ is the interaction term of between freelunch and switch status. 

```{r, echo=FALSE}
full = aov(g1tmathss~g1freelunch*switch + g1classtype + g1schid, data=combine_id)

anova(t1, full, test='Chisq')
```

Testing a full vs reduced model to see if an interaction between free lunch and switch status indicates that the interaction provides significant information in the model. However, I believe that leaving the interaction out of the model is still valid and should be used because the main effect plot of the interaction indicates that it isn't as important as the test may make it appear.

# Conclusion

From the analysis done, the following conclusions are drawn:

1. class type, free lunch status, switch status, and school id all have an effect on grade 1 math scores
2. From current analysis, there is no missing mechanism behind why students were missing grade 1 math scores even if they were participating in project STAR. Similarly there is no missing mechanism for why the 4 schools were missing teacher + aide for grade 1
3. The coefficients for school id from the model follow a similar pattern to the average math score when grouping by school id.
4. There may be an underlying mechanism that yields the pattern shown for school id and average math scores but further analysis is required.




# Appendix

### Cleaning Summary
In summary this is how the data was cleaned:

1. removed 3->high school data
2. retrieved all the students that had available data on their grade 1 math scores
3. looked into the distribution of students that were missing grade 1 math scores
  + removed students who were missing kindergarten or grade 2 test scores from these missing grade 1 math scores
4. Used linear regression to impute the missing grade 1 math scores using kindergarten and grade 2 test scores
5. imputed grade 1 free lunch status for missing elements based on the free lunch status when they were in kindergarten or second grade if kindergarten was missing
  + removed the remaining students that did not have any information to impute on their free lunch status for first grade (missing kindergarten and second grade etc)
6. Joined this dataset with the k-3 school information to glean information on the schools the students were attending



### Tables

```{r, echo=FALSE}
proportion_first_grade_free <- df %>%
  inner_join(df1, by=c('g1schid' = 'schid')) %>%
  group_by(SCHLURBN) %>%
  summarize(student_count = n(),
            prop = sum(g1freelunch=="FREE LUNCH", na.rm=TRUE)/n())


ggplot(proportion_first_grade_free, aes(x=SCHLURBN, y=prop)) +
  geom_bar(stat = 'identity', color='black') +
  labs(x = "School Type", y = "Proportion of 1st grade students with Free Lunch", title = "Proportion of 1st Grade Students with Free Lunch by School") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



```{r}

ggplot(na_filtered_yes, aes(x = gender)) +
  geom_bar(fill = "skyblue") +
  labs(x = "Gender", y = "Count", title = "Counts of Male and Female") +
  theme_minimal()

```

```{r}
ggplot(na_filtered_yes, aes(x=race)) +
  geom_bar(fill="skyblue") +
  labs(x="Gender", y="Count", title="Count of Ethnicity")
```

```{r}
ggplot(na_filtered_yes, aes(x=g1surban)) +
  geom_bar(fill="skyblue") +
  labs(x="Living Area Classification", y="Count", title="Student Living Area Classification")
```


```{r}
a <- na_filtered_yes %>%
  summarize(NA_count = sum(is.na(g1treadss)),
            non_NA = sum(is.na(g1treadss)))

count_data_long <- tidyr::pivot_longer(a, cols = c(NA_count, non_NA), names_to = "Category", values_to = "Count")

# Create a bar plot
ggplot(count_data_long, aes(x = Category, y = Count, fill = Category)) +
  geom_bar(stat = "identity") +
  labs(x = "Category", y = "Count", title = "Count of student's who are also missing G1 reading scores") +
  scale_fill_manual(values = c("skyblue", "orange"), labels = c("Missing", "Not Missing")) +
  theme_minimal()
```


```{r}
t2=aov(g1tmathss~g1classtype + switch + g1freelunch * g1schid, data=combine_id)
id_coef <- t2$coefficients[7:81]

coef_df <- data.frame(Coefficients = unlist(id_coef))

coef_df <- rownames_to_column(coef_df, var = "index_column")

coef_df <- coef_df %>%
  rename(
    schid = index_column
  )

coef_df$schid <- sub("^g1schid", "", coef_df$schid)

full_graph_data_coef <- full_graph_data %>%
  inner_join(coef_df, by=c("g1schid" = "schid"))

full_graph_data_coef

full_graph_data_coef$g1schid <- factor(full_graph_data_coef$g1schid, levels = unique(full_graph_data_coef$g1schid))


ggplot(full_graph_data_coef, aes(x=g1schid, y=Coefficients, color = urbn)) +
  geom_point() +
  labs(x = "School ID", y = "Average Math Score", title = "Coefficients (Interaction Model)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

